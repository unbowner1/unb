<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>One-Room Collaborative Whiteboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      height: 100vh;
      display: flex;
      flex-direction: column;
      background: #f5f5f7;
      color: #222;
    }

    header {
      height: 56px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 16px;
      background: #ffffff;
      border-bottom: 1px solid #ddd;
    }

    header .logo {
      font-weight: 700;
      font-size: 18px;
      letter-spacing: 0.03em;
    }

    main {
      flex: 1;
      display: flex;
      min-height: 0;
    }

    .sidebar {
      width: 220px;
      max-width: 80vw;
      background: #fafafa;
      border-right: 1px solid #ddd;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .sidebar-section {
      padding: 10px 12px;
      border-radius: 8px;
      background: #ffffff;
      border: 1px solid #e2e2e2;
      font-size: 13px;
    }

    .sidebar h2 {
      font-size: 15px;
      margin-bottom: 6px;
    }

    .sidebar button {
      width: 100%;
      margin-top: 6px;
      padding: 6px 8px;
      font-size: 13px;
      border-radius: 6px;
      border: 1px solid #ccc;
      background: #007bff;
      color: #fff;
      cursor: pointer;
      font-weight: 500;
    }

    .sidebar button.secondary {
      background: #f0f0f0;
      color: #333;
      border: 1px solid #ccc;
    }

    .sidebar button:hover {
      filter: brightness(0.95);
    }

    .sidebar .small {
      font-size: 12px;
      color: #777;
      margin-top: 6px;
    }

    .board-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-width: 0;
    }

    .board-toolbar {
      height: 48px;
      display: flex;
      align-items: center;
      padding: 0 12px;
      gap: 8px;
      background: #ffffff;
      border-bottom: 1px solid #ddd;
    }

    .tool-btn {
      padding: 6px 10px;
      font-size: 13px;
      border-radius: 6px;
      border: 1px solid #ccc;
      background: #f8f8f8;
      cursor: pointer;
    }

    .tool-btn.active {
      background: #007bff;
      color: #fff;
      border-color: #007bff;
    }

    .board-toolbar input[type="color"] {
      border: none;
      background: transparent;
      padding: 0;
      width: 32px;
      height: 24px;
      cursor: pointer;
    }

    .board-toolbar input[type="range"] {
      width: 120px;
    }

    .board-wrapper {
      flex: 1;
      position: relative;
      background: #f5f5f7;
      overflow: hidden;
    }

    canvas {
      background: #ffffff;
      border-radius: 4px;
      box-shadow: 0 0 0 1px #ddd;
      position: absolute;
      top: 16px;
      left: 16px;
      right: 16px;
      bottom: 16px;
      width: calc(100% - 32px);
      height: calc(100% - 32px);
      touch-action: none;
    }

    footer {
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      color: #777;
      background: #fafafa;
      border-top: 1px solid #ddd;
    }

    @media (max-width: 768px) {
      main {
        flex-direction: column;
      }
      .sidebar {
        width: 100%;
        border-right: none;
        border-bottom: 1px solid #ddd;
        flex-direction: row;
        flex-wrap: wrap;
      }
      .sidebar-section {
        flex: 1 1 160px;
      }
    }
  </style>

  <!-- Firebase v8 -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
</head>
<body>
  <header>
    <div class="logo">One-Room Collaborative Whiteboard</div>
  </header>

  <main>
    <aside class="sidebar">
      <div class="sidebar-section">
        <h2>Board</h2>
        <p>Everyone who opens this page is on the same board.</p>
        <p class="small">No rooms, no IDs, just one shared space.</p>
      </div>

      <div class="sidebar-section">
        <h2>Actions</h2>
        <button id="clearBoardBtn" class="secondary">Clear whiteboard for everyone</button>
        <button id="downloadPngBtn">Download as PNG</button>
        <p class="small">Clearing wipes the board for all connected users.</p>
      </div>
    </aside>

    <section class="board-container">
      <div class="board-toolbar">
<button class="tool-btn active" data-tool="pen">Pen</button>
<button class="tool-btn" data-tool="eraser">Eraser</button>
<button class="tool-btn" data-tool="highlighter">Highlighter</button>
<button class="tool-btn" data-tool="marker">Marker</button>
<button class="tool-btn" data-tool="pencil">Pencil</button>
<button class="tool-btn" data-tool="rainbow">Rainbow</button>

        <span style="font-size:13px;margin-left:8px;">Color</span>
        <input type="color" id="colorPicker" value="#000000" />

        <span style="font-size:13px;margin-left:8px;">Size</span>
        <input type="range" id="sizeRange" min="1" max="30" value="4" />

        <span style="margin-left:auto;font-size:12px;color:#777;">
          One global board · Live for everyone
        </span>
      </div>

      <div class="board-wrapper">
        <canvas id="board"></canvas>
      </div>
    </section>
  </main>

  <footer>
    © 2025 One-Room Whiteboard · Educational use only
  </footer>

  <script>
    let shapeStart = null;
    // 1. Firebase setup – replace with your real config
    const firebaseConfig = {
    apiKey: "AIzaSyCsxLxY1CNS0VAgrv5XTq8nIgdoKx31i7M",
    authDomain: "one-room-whiteboard.firebaseapp.com",
    projectId: "one-room-whiteboard",
    storageBucket: "one-room-whiteboard.firebasestorage.app",
    messagingSenderId: "511222605196",
    appId: "1:511222605196:web:db7bc8c060260cf538e2a9",
    measurementId: "G-21DXHJ6CG5"
  };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const strokesRef = db.ref("whiteboard/strokes");
    const clearRef = db.ref("whiteboard/clear");

    const clientId = Math.random().toString(36).slice(2);

    // 2. Canvas setup
    const canvas = document.getElementById("board");
    const ctx = canvas.getContext("2d");

    function resizeCanvas() {
      const rect = canvas.getBoundingClientRect();
      const temp = document.createElement("canvas");
      temp.width = canvas.width;
      temp.height = canvas.height;
      temp.getContext("2d").drawImage(canvas, 0, 0);

      canvas.width = rect.width;
      canvas.height = rect.height;
      ctx.drawImage(temp, 0, 0, rect.width, rect.height);
    }

    window.addEventListener("resize", resizeCanvas);
    setTimeout(resizeCanvas, 50);

    let drawing = false;
    let tool = "pen";
    let strokeColor = "#000000";
    let strokeSize = 4;
    let lastX = 0;
    let lastY = 0;

    const toolButtons = document.querySelectorAll(".tool-btn");
    const colorPicker = document.getElementById("colorPicker");
    const sizeRange = document.getElementById("sizeRange");
    const clearBoardBtn = document.getElementById("clearBoardBtn");
    const downloadPngBtn = document.getElementById("downloadPngBtn");

    toolButtons.forEach(btn => {
      btn.addEventListener("click", () => {
        toolButtons.forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        tool = btn.dataset.tool;
      });
    });

    colorPicker.addEventListener("input", e => {
      strokeColor = e.target.value;
    });

    sizeRange.addEventListener("input", e => {
      strokeSize = parseInt(e.target.value, 10);
    });

    function getPos(e) {
      const rect = canvas.getBoundingClientRect();
      if (e.touches && e.touches[0]) {
        return {
          x: e.touches[0].clientX - rect.left,
          y: e.touches[0].clientY - rect.top
        };
      }
      return {
        x: e.clientX - rect.left,
        y: e.clientY - rect.top
      };
    }

   function applyStroke(s) {
  ctx.save();
  ctx.lineCap = "round";
  ctx.lineJoin = "round";

  // Default settings
  ctx.globalCompositeOperation = "source-over";
  ctx.strokeStyle = s.color;
  ctx.lineWidth = s.size;

  // Brush types
  switch (s.tool) {
    case "eraser":
      ctx.globalCompositeOperation = "destination-out";
      ctx.strokeStyle = "rgba(0,0,0,1)";
      break;

case "highlighter":
  ctx.globalCompositeOperation = "source-over";
  ctx.strokeStyle = s.color;
  ctx.lineWidth = s.size * 3;

  // Each stroke is semi-transparent.
  // Overlapping strokes darken naturally.
  ctx.globalAlpha = 0.22;
  break;


case "marker":
  ctx.globalCompositeOperation = "source-over";
  ctx.strokeStyle = s.color;
  ctx.lineWidth = s.size * 2.2;
  ctx.globalAlpha = 1.0;
  break;


case "pencil":
  ctx.globalCompositeOperation = "source-over";
  ctx.strokeStyle = s.color + "AA"; // 66% opacity
  ctx.lineWidth = s.size * 0.7;
  ctx.globalAlpha = 0.7;
  break;

  case "calligraphy":
  ctx.globalCompositeOperation = "source-over";
  ctx.strokeStyle = s.color;
  ctx.lineWidth = s.size * 2;

  // Angle the nib
  ctx.lineCap = "butt";
  ctx.lineJoin = "miter";

  // Slight angle effect
  ctx.transform(1, 0.2, -0.2, 1, 0, 0);
  break;

  case "highlighter":
  ctx.globalCompositeOperation = "source-over";
  ctx.strokeStyle = s.color;
  ctx.lineWidth = s.size * 3;
  ctx.globalAlpha = 0.22; // darkens each new stroke
  break;


    case "rainbow":
      const hue = (s.ts % 360);
      ctx.strokeStyle = `hsl(${hue}, 100%, 50%)`;
      break;


  }

  // Draw the stroke
  ctx.beginPath();
  ctx.moveTo(s.x1, s.y1);
  ctx.lineTo(s.x2, s.y2);
  ctx.stroke();
  ctx.restore();
}

    function sendStroke(stroke) {
      strokesRef.push(stroke);
    }

    function startDraw(e) {
      e.preventDefault();
      drawing = true;
      const pos = getPos(e);
      lastX = pos.x;
      lastY = pos.y;
      if (tool === "line" || tool === "rect" || tool === "circle") {
  shapeStart = getPos(e);
  return;
}

    }

    function draw(e) {
      if (!drawing) return;
      e.preventDefault();
      const pos = getPos(e);

      const stroke = {
        x1: lastX,
        y1: lastY,
        x2: pos.x,
        y2: pos.y,
        color: strokeColor,
        size: strokeSize,
        tool: tool,
        clientId: clientId,
        ts: Date.now()
      };

      applyStroke(stroke);
      sendStroke(stroke);

      lastX = pos.x;
      lastY = pos.y;
    }

    function endDraw(e) {
      if (!drawing) return;
      e.preventDefault();
      drawing = false;
      if (shapeStart && (tool === "line" || tool === "rect" || tool === "circle")) {
  const end = getPos(e);

  const stroke = {
    tool: tool,
    x1: shapeStart.x,
    y1: shapeStart.y,
    x2: end.x,
    y2: end.y,
    color: strokeColor,
    size: strokeSize,
    clientId: clientId,
    ts: Date.now()
  };

  applyStroke(stroke);
  sendStroke(stroke);

  shapeStart = null;
}

    }

    canvas.addEventListener("mousedown", startDraw);
    canvas.addEventListener("mousemove", draw);
    canvas.addEventListener("mouseup", endDraw);
    canvas.addEventListener("mouseleave", endDraw);

    canvas.addEventListener("touchstart", startDraw, { passive: false });
    canvas.addEventListener("touchmove", draw, { passive: false });
    canvas.addEventListener("touchend", endDraw, { passive: false });
    canvas.addEventListener("touchcancel", endDraw, { passive: false });

    // Firebase listeners
    strokesRef.on("child_added", snap => {
      const s = snap.val();
      if (s.clientId === clientId) return;
      applyStroke(s);
    });

    clearRef.on("value", snap => {
      const val = snap.val();
      if (val && val.ts) {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
      }
    });

    // Controls
    clearBoardBtn.addEventListener("click", () => {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      clearRef.set({ ts: Date.now() });
      strokesRef.remove();
    });

    downloadPngBtn.addEventListener("click", () => {
      const link = document.createElement("a");
      link.download = "whiteboard.png";
      link.href = canvas.toDataURL("image/png");
      link.click();
    });
  </script>
</body>
</html>
